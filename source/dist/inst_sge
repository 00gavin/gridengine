#!/bin/sh
#
# SGE/SGEEE installation script
#
#___INFO__MARK_BEGIN__
##########################################################################
#
#  The Contents of this file are made available subject to the terms of
#  the Sun Industry Standards Source License Version 1.2
#
#  Sun Microsystems Inc., March, 2001
#
#
#  Sun Industry Standards Source License Version 1.2
#  =================================================
#  The contents of this file are subject to the Sun Industry Standards
#  Source License Version 1.2 (the "License"); You may not use this file
#  except in compliance with the License. You may obtain a copy of the
#  License at http://gridengine.sunsource.net/Gridengine_SISSL_license.html
#
#  Software provided under this License is provided on an "AS IS" basis,
#  WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING,
#  WITHOUT LIMITATION, WARRANTIES THAT THE SOFTWARE IS FREE OF DEFECTS,
#  MERCHANTABLE, FIT FOR A PARTICULAR PURPOSE, OR NON-INFRINGING.
#  See the License for the specific provisions governing your rights and
#  obligations concerning the Software.
#
#  The Initial Developer of the Original Code is: Sun Microsystems, Inc.
#
#  Copyright: 2001 by Sun Microsystems, Inc.
#
#  All Rights Reserved.
#
##########################################################################
#___INFO__MARK_END__
#
# set -x

# Reset PATH to a safe value
#
PATH=/bin:/usr/bin

# Easy way to prevent clearing of screen
#
CLEAR=clear
#CLEAR=:

# set to false if you don't want this script uses the i18n functions
#
SGE_I18N=true

#-------------------------------------------------------------------------
# USEFUL LOCAL SHELL PROCEDURES

#-------------------------------------------------------------------------
# ErrUsage: print usage string, exit
#
ErrUsage()
{
   myname=`basename $0`
   $ECHO "" >&2
   Translate 3 "Usage: "
   $ECHO       "$myname -m|-x|-s [-nostrict] [-fast] [-auto] [-noqueue] [-csp] [-resport] [-afs]" >&2
   $ECHO       "     -m        \c" >&2
   Translate 1 "install qmaster host"
   $ECHO       "     -x        \c" >&2
   Translate 1 "install execution host or queueing system transfer host"
   $ECHO       "     -s        \c" >&2
   Translate 1 "how to install submit host"
   $ECHO       "     -fast     \c" >&2
   Translate 1 "install system with default options"
   $ECHO       "     -nostrict \c" >&2
   Translate 1 "do not check %s for write permissions" \$$QSYST_ROOT
   $ECHO       "     -auto     \c" >&2
   Translate 1 "auto answer all questions with default, do not wait at prompt"
   $ECHO     "     -csp      \c" >&2
   Translate 1 "install system with security framework protocol functionality"
   $ECHO     "     -afs      \c" >&2
   Translate 1 "install system with AFS functionality"
   $ECHO       "     -resport  \c" >&2
   Translate 1 "install system with reserved port security"
   $ECHO "" >&2

   exit 1
}

#-------------------------------------------------------------------------
# PreCheckForFastInstall: return 0 if all conditions for an accelerated
# installation procedure are met
# 
PreCheckForFastInstall()
{

   if [ $resport = true ]; then
      commd_port_max=1023
   else
      commd_port_max=65500
   fi

   # must be first check - sets variable $euid
   euid=`$V5UTILBIN/uidgid -euid`

   if [ $fast = false ]; then
      return 1
   fi

   if [ $euid != 0 ]; then
      return 1
   fi

   $V5UTILBIN/getservbyname $QSYST_SERVICE  >/dev/null 2>&1
   ret=$?

   if [ $ret = 1 -a "$COMMD_PORT" = "" ]; then
      return 1
   fi

   if [ "$COMMD_PORT" != "" ]; then
      if [ "$COMMD_PORT" -le 1 -o $COMMD_PORT -ge $commd_port_max ]; then
         return 1
      fi
   fi


   this_dir_user=`$V5UTILBIN/filestat -owner .`

   if [ $this_dir_user = root ]; then
      touch ./tst$$ 2> /dev/null > /dev/null
      ret=$?
      rm -f ./tst$$
      if [ $ret != 0 ]; then
         return 1
      fi
   else
      ADMINUSER=$this_dir_user
      ExecuteAsAdmin $TOUCH ./tst$$ 2> /dev/null > /dev/null
      ret=$?
      ExecuteAsAdmin $RM -f ./tst$$
      if [ $ret != 0 ]; then
         return 1
      fi
   fi

   return 0
}

#-------------------------------------------------------------------------
# Ask the installer for the host name resolving method
# (IGNORE_FQND=true/false)
#
SelectHostNameResolving()
{
   $CLEAR
   $ECHO
   Translate 0 "Select default hostname resolving method"
   $ECHO "$LINES-------------------------------------"
   $ECHO ""
   Translate 0 "Are all hosts of your cluster in one DNS domain? If this is"
   Translate 0 "the case the host names"
   $ECHO ""
   Translate 0 "   >%s< and >%s<" hostA hostA.foo.com
   $ECHO ""
   Translate 0 "would be treated as eqal, because the DNS domain name >foo.com<"
   Translate 0 "is ignored when comparing host names."

   Translate 4 "Are all the hosts of your cluster in a single DNS domain"
   YesNo "\n$transout" y
   $ECHO
   if [ $? = 0 ]; then
      IGNORE_FQDN_DEFAULT=true
      Translate 0 "Ignoring domainname when comparing hostnames."
   else
      IGNORE_FQDN_DEFAULT=false
      Translate 0 "The domainname is not ignored when comparing hostnames."
   fi
   $ECHO
   WaitClear clear

}

#-------------------------------------------------------------------------
# Check whether the qmaster is installed and the file systems is shared
#
CheckCellDirectory()
{
   $CLEAR

   check_cell_error=0
   if [ ! -d $COMMONDIR ]; then
      Translate 4 "common directory not found: %s" $COMMONDIR 
   fi

   if [ ! -f $COMMONDIR/configuration ]; then
      if [ $check_cell_error = 0 ]; then
         Translate 4 "configuration file not found: %s" $COMMONDIR/configuration
      fi
      check_cell_error=1
   fi

   if [ ! -f $COMMONDIR/act_qmaster ]; then
      if [ $check_cell_error = 0 ]; then
         Translate 4 "%s file not found: %s" act_qmaster $COMMONDIR/act_qmaster
      fi
      check_cell_error=1
   fi
   

   if [ $check_cell_error != 0 ]; then
      transsaved="$transout"
      $ECHO ""
      Translate 0 "Checking cell directory"
      $ECHO "$LINES-----------------"
      $ECHO ""
      Translate 0 "Cannot find required files. The following error was returned:"
      $ECHO ""
      $ECHO "$transsaved"
      $ECHO ""
      Translate 0 "Please make sure that you have installed the qmaster host before"
      Translate 0 "installing an execd host."
      $ECHO ""
      Translate 0 "The installation procedure will only work if you use a shared"
      Translate 0 "directory (e.g. shared with NFS) for your installation."
      $ECHO ""
      Translate 0 "The installation of the execution daemon will abort now."
      $ECHO ""
      Translate 4 "Hit <RETURN> to cancel the installation >>"
      WaitClear noclear "$transout \c"
      exit 1
   fi
}


#-------------------------------------------------------------------------
# Check the host names and put out warning message on probably wrong
# hostname resolving
#
CheckHostNameResolving()
{

   resolve_get_configuration=`ExecuteAsAdmin $V5BIN/qconf -sconf global | grep "^ignore_fqdn" `
   resolve_qmaster_params=`echo $resolve_get_configuration | egrep -i "true|1"`
   if [ "$resolve_qmaster_params" = "" ]; then
      $ECHO ""
      set IGNORE_FQDN_DEFAULT=false
   else
#     don't need this check when IGNORE_FQDN=true in qmaster_params
      set IGNORE_FQDN_DEFAULT=true
      return
   fi

   done=false
   loop_counter=0
   while [ $done = false ]; do
       done=false
       $CLEAR
       $ECHO ""
       Translate 0 "Checking host name resolving"
       $ECHO "$LINES----------------------"
       $ECHO ""
       resolve_admin_hosts=`ExecuteAsAdmin $V5BIN/qconf -sh`
       resolve_this_hostname=`ExecuteAsAdmin $V5UTILBIN/gethostname -name`
       resolve_default_domain=`ExecuteAsAdmin $V5BIN/qconf -sconf global | grep "^default_domain" | awk '{print $2}'`

       if [ "$resolve_default_domain" = "" ]; then
           resolve_default_domain="none"
       fi

       Translate 0 "This host has the local hostname >%s<." $resolve_this_hostname

       resolve_default_domain_upper=`echo $resolve_default_domain | tr "[a-z]" "[A-Z]"`
       if [ "$resolve_default_domain_upper" != "NONE" ]; then
            resolve_tmp_name=`echo $resolve_this_hostname | cut -f 1 -d "."`
            if [ "$resolve_tmp_name" = "$resolve_this_hostname" ]; then
                resolve_this_hostname="$resolve_this_hostname.$resolve_default_domain"

                Translate 0 "The default_domain parameter is set in the global configuration"
                Translate 0 "and added to the unqualified hostname."
                Translate 0 "As a result the execd on this host would return the following hostname:"
                $ECHO "\"$resolve_this_hostname\""
            fi
       fi
       resolve_upper_this_hostname=`echo $resolve_this_hostname | tr "[a-z]" "[A-Z]"`
       for i in $resolve_admin_hosts; do
           resolve_upper_admin_hostname=`echo $i | tr "[a-z]" "[A-Z]"`
           if [ "$resolve_upper_admin_hostname" = "$resolve_upper_this_hostname" ]; then

              Translate 0 "This host is resolved correctly."

              done=true
              break
           fi
       done
       if [ $done = false ]; then
           Translate 0 "This host is unknown on the qmaster host."
           $ECHO ""
           $ECHO "$LINES--------------------------------------"
           $ECHO
           Translate 0 "Please make sure that you added this host as administrative host!"
           Translate 0 "If you did not, add this host with"
           $ECHO
           $ECHO     "         \"qconf -ah HOSTNAME\""
           $ECHO
           Translate 0 "on your qmaster host."
           $ECHO ""
           if [ $loop_counter != 0 ]; then
               Translate 0 "If this host is already added as administrative host on your qmaster host,"
               Translate 0 "there may be a hostname resolving problem on this machine."
               $ECHO ""
               Translate 0 "Please check your /etc/hosts file and nsswitch configuration file !"
               $ECHO ""
               Translate 0 "Hostname resolving problems will cause the problem that the execution host"
               Translate 0 "will not be accepted by qmaster. The qmaster will get no load report values"
               Translate 0 "and show a load value (%s) of %s for this host." load_avg 99.99
               $ECHO ""
               if [ $autoinst = true ]; then
                   exit 1
               fi
           fi
           $ECHO "$LINES--------------------------------------"
           $ECHO ""
           Translate 2 "Check again [Y/N] [Y] >> "
           INP=`Enter Y`
           if [ $INP = y -o $INP = Y ]; then
               done=false
           else
               done=true
           fi

       else
           WaitClear clear
           return
       fi
       loop_counter=`expr $loop_counter + 1`
   done
}

#-------------------------------------------------------------------------
# AskIfDefaultOkAndSetVariables
# 
AskIfDefaultOkAndSetVariables()
{
   eval $QSYST_ROOT=`pwd | sed 's/\/tmp_mnt//'`
   export $QSYST_ROOT
   QSYST_ROOT_VAL=`eval echo '$'$QSYST_ROOT`

   QMDIR=$QSYST_ROOT_VAL/$QSYST_CELL_VAL/spool/qmaster

   SetCellDependentVariables

   $ECHO ""
   Translate 0 "Confirm %s default installation settings" "$QSYST"
   $ECHO "$LINES--------------------------------------"
   $ECHO ""

   Translate 0 "The following default settings can be used for an accelerated"
   Translate 0 "installation procedure:"
   $ECHO ""
   $ECHO "   \$$QSYST_ROOT$BLANKS        = $QSYST_ROOT_VAL"

   if [ "$COMMD_PORT" != "" ]; then
      $ECHO "   \$COMMD_PORT        = $COMMD_PORT"
   else
      $ECHO "   service            = $QSYST_SERVICE"
   fi

   if [ $ADMINUSER = default ]; then
      $ECHO "   admin user account = root"
   else
      $ECHO "   admin user account = $ADMINUSER"
   fi

   if [ "$QSYST_CELL_VAL" != "default" ]; then
      $ECHO "   cell name          = $QSYST_CELL_VAL"
   fi


   Translate 4 "Do you want to use these configuration parameters"
   YesNo "\n$transout" y

   if [ $? = 0 ]; then
      return 0;
   else
      return 1;
   fi
}

#---------------------------------------------------
# SetFilePerm
# set file permissions to 644 and dirs. to 755 and change owner to admin
# user
#
SetFilePerm()
{
   f="$1"
   Translate 0 "Verifying and setting file permissions in >%s<" "$f"
   chmod -R go+r $f
   find $f -type d -exec chmod 755 {} \;
   find $f -type f -perm -100 -exec chmod go+x {} \;

   if [ $ADMINUSER != default ]; then
        chown -R $ADMINUSER $f
   fi
}

#-------------------------------------------------------------------------
# Makedir: make directory, chown/chgrp/chmod it. Exit if failure
#
Makedir()
{
   file=$1
   if [ ! -d $file ]; then
       Translate 0 "making %s" "$file"
       ExecuteAsAdmin $MKDIR -p $1
    fi

   ExecuteAsAdmin $CHMOD $DIRPERM $file
}

#-------------------------------------------------------------------------
# SetPerm: set permissions, chown, chgrp
#
SetPerm()
{
   file=$1
   ExecuteAsAdmin $CHMOD $FILEPERM $file
}

#-------------------------------------------------------------------------
# Make directories needed by qmaster
#
MakeDirsMaster()
{
   $ECHO ""
   Translate 0 "Making directories"
   $ECHO "------------------"
   Makedir $QSYST_CELL_VAL
   Makedir $COMMONDIR
   Makedir $HISTDIR
   Makedir $LCONFDIR
   Makedir $QMDIR
   Makedir $QMDIR/admin_hosts
   Makedir $QMDIR/ckpt
   Makedir $QMDIR/complexes
   Makedir $QMDIR/exec_hosts
   Makedir $QMDIR/job_scripts
   Makedir $QMDIR/jobs
   Makedir $QMDIR/pe
   Makedir $QMDIR/queues
   Makedir $QMDIR/submit_hosts
   Makedir $QMDIR/usersets

   WaitClear clear
}

#-------------------------------------------------------------------------
# PrintLocalConf:  print execution host local SGE/SGEEE configuration
#
PrintLocalConf()
{
   arg=$1
   if [ $arg = 1 ]; then
      $ECHO "conf_version           0"
   fi
   $ECHO "mailer                 $MAILER"
   $ECHO "xterm                  $XTERM"
   $ECHO "qlogin_command         $QLOGIN_COMMAND"
   $ECHO "qlogin_daemon          $QLOGIN_DAEMON"
   $ECHO "rlogin_daemon          $RLOGIN_DAEMON"
}

#-------------------------------------------------------------------------
# PrintConf: print SGE/SGEEE default configuration
#
PrintConf()
{
   $ECHO "conf_version           0"
   $ECHO "qmaster_spool_dir      $QMDIR"
   $ECHO "execd_spool_dir        $CFG_EXE_SPOOL"
   $ECHO "binary_path            $QSYST_ROOT_VAL/bin"
   $ECHO "mailer                 $MAILER"
   $ECHO "xterm                  $XTERM"
   $ECHO "load_sensor            none"
   $ECHO "prolog                 none"
   $ECHO "epilog                 none"
   $ECHO "shell_start_mode       posix_compliant"
   $ECHO "login_shells           sh,ksh,csh,tcsh"
   $ECHO "min_uid                0"
   $ECHO "min_gid                0"
   $ECHO "user_lists             none"
   $ECHO "xuser_lists            none"
   if [ $inst = sgeee ]; then
      $ECHO "projects               none"
      $ECHO "xprojects              none"
   fi
   $ECHO "load_report_time       00:00:40"
   $ECHO "stat_log_time          48:00:00"
   $ECHO "max_unheard            00:05:00"
   $ECHO "reschedule_unknown     00:00:00"
   $ECHO "loglevel               log_warning"
   if [ $inst = sgeee ]; then
      $ECHO "enforce_project        false"
      $ECHO "enforce_user           false"
   fi
   $ECHO "administrator_mail     $CFG_MAIL_ADDR"
   if [ $afs = true ]; then
      $ECHO "set_token_cmd          /path_to_token_cmd/set_token_cmd"
      $ECHO "pag_cmd                /usr/afsws/bin/pagsh"
      $ECHO "token_extend_time      24:0:0"
   else
      $ECHO "set_token_cmd          none"
      $ECHO "pag_cmd                none"
      $ECHO "token_extend_time      none"
   fi
   $ECHO "shepherd_cmd           none"
   $ECHO "qmaster_params         none"
   $ECHO "schedd_params          none"
   $ECHO "execd_params           none"
   $ECHO "finished_jobs          100"
   $ECHO "gid_range              $CFG_GID_RANGE"
   if [ $ADMINUSER != default ]; then
      $ECHO "admin_user             $ADMINUSER"
   else
      $ECHO "admin_user             none"
   fi
   $ECHO "qlogin_command         $QLOGIN_COMMAND"
   $ECHO "qlogin_daemon          $QLOGIN_DAEMON"
   $ECHO "rlogin_daemon          $RLOGIN_DAEMON"
   $ECHO "default_domain         $CFG_DEFAULT_DOMAIN"
   $ECHO "ignore_fqdn            true"
   $ECHO "max_aj_instances       2000"
   $ECHO "max_aj_tasks           75000"
   $ECHO "max_u_jobs             0"
}

#-------------------------------------------------------------------------
# GetGidRange
#
GetGidRange()
{
   done=false
   while [ $done = false ]; do
      $CLEAR
      $ECHO ""
      Translate 0 "%s group id range" "$QSYST"
      $ECHO "$LINES---------------"
      $ECHO ""
      Translate 0 "When jobs are started under the control of SGEEE an additional group id is set"
      Translate 0 "on platforms which do not support jobs. This is done to provide maximum control"
      Translate 0 "for SGEEE jobs."
      Translate 0 "This additional UNIX group id range must be unused group id's in your system."
      Translate 0 "Each job will be assigned a unique id during the time it is running."
      Translate 0 "Therefore you need to provide a range of id's which will be assigned"
      Translate 0 "dynamically for jobs."
      Translate 0 "The range must be big enough to provide enough numbers for the maximum number"
      Translate 0 "of SGEEE jobs running at a single moment on a single host. E.g. a range like"
      $ECHO ""
      Translate 0 "   20000-20100"
      $ECHO ""
      Translate 0 "means, that SGEEE will use the group ids from 20000-20100 and provides a range"
      Translate 0 "for 100 SGEEE jobs at the same time on a single host."
      Translate 0 "You can change at any time the group id range in your cluster configuration."
      $ECHO ""
      Translate 2 "Please enter a range: "

      CFG_GID_RANGE=`Enter ""`

      if [ "$CFG_GID_RANGE" != "" ]; then
         Translate 0 "Using >%s< as gid range." "$CFG_GID_RANGE"
         $ECHO
         WaitClear clear
         done=true
      fi
   done
}

#-------------------------------------------------------------------------
# GetDefaultDomain
# 
GetDefaultDomain()
{
   done=false
   while [ $done = false ]; do
      $CLEAR
      $ECHO ""
      Translate 0 "Default domain for hostnames"
      $ECHO "----------------------------"
      $ECHO
      Translate 0 "Sometimes the primary hostname of machines returns the short hostname"
      Translate 0 "without a domain suffix like >%s<." company.com
      $ECHO
      Translate 0 "This can cause problems with getting load values of your execution hosts."
      $ECHO
      Translate 0 "If you are using DNS or you are using domains in your >%s< file or" /etc/hosts
      Translate 0 "your NIS configuration it is usually safe to define a default domain"
      Translate 0 "because it is only used if your execution hosts return the short hostname"
      Translate 0 "as their primary name."
      $ECHO
      Translate 0 "If your execution hosts reside in more than one domain, the default domain"
      Translate 0 "parameter must be set on all execution hosts individually."
      $ECHO

      Translate 4 "Do you want to configure a default domain"
      YesNo "$transout" y
      if [ $? = 0 ]; then
         Translate 2 "\nPlease enter your default domain: "
         CFG_DEFAULT_DOMAIN=`Enter ""`
         if [ "$CFG_DEFAULT_DOMAIN" != "" ]; then
            $ECHO
            Translate 0 "Using >%s< as default domain" $CFG_DEFAULT_DOMAIN
            WaitClear clear
         fi
      else
         CFG_DEFAULT_DOMAIN=none
      fi
      done=true
   done
}

#-------------------------------------------------------------------------
# GetConfiguration: get some parameters for global configuration
#
GetConfiguration()
{

   GetGidRange

   if [ $fast = false -a "$IGNORE_FQDN_DEFAULT" = false ]; then
      GetDefaultDomain
   else
      CFG_DEFAULT_DOMAIN=none
   fi

   if [ $fast = true ]; then
      CFG_EXE_SPOOL=$QSYST_ROOT_VAL/$QSYST_CELL_VAL/spool
      CFG_MAIL_ADDR=none
      return 0
   fi

   done=false
   while [ $done = false ]; do
      $CLEAR
      $ECHO ""
      Translate 0 "%s cluster configuration" "$QSYST"
      $ECHO "$LINES----------------------"

      $ECHO ""
      Translate 0  "Please give the basic configuration parameters of your %s installation:" "$QSYST"
      $ECHO ""
      $ECHO "<execd_spool_dir>"
      $ECHO ""

      if [ $ADMINUSER != default ]; then
            Translate 0  "The pathname of the spool directory of the execution hosts. User >%s<" "$ADMINUSER"
      elif [ $euid = 0 ]; then
            Translate 0 "The pathname of the spool directory of the execution hosts. The user root"
      else
            Translate 0 "The pathname of the spool directory of the execution hosts. You"
      fi

      Translate 0 "must have the right to create this directory and to write into it."
      $ECHO ""
      Translate 2 "Default: (%s) >> " $QSYST_ROOT_VAL/$QSYST_CELL_VAL/spool

      CFG_EXE_SPOOL=`Enter $QSYST_ROOT_VAL/$QSYST_CELL_VAL/spool`

      $CLEAR

      $ECHO ""
      $ECHO "<administrator_mail>"
      $ECHO ""
      Translate 0 "The email address of the administrator to whom problem reports are sent."
      $ECHO ""
      Translate 0 "It's is recommended to configure this parameter. You may use >none<"
      Translate 0 "if you do not wish to receive administrator mail."
      $ECHO ""
      Translate 0 "Please enter an email address in the form"
      $ECHO ""
      $ECHO "   \"user@foo.com\""
      $ECHO ""
      Translate 2 "Default: (%s) >> " none

      CFG_MAIL_ADDR=`Enter none`

      $CLEAR
      $ECHO ""
      Translate 0 "The following parameters for the cluster configuration were configured:"
      $ECHO ""
      $ECHO "   execd_spool_dir        $CFG_EXE_SPOOL"
      $ECHO "   administrator_mail     $CFG_MAIL_ADDR"
      $ECHO ""

      Translate 4 "Do you want to change the configuration parameters"
      YesNo "$transout" n
      if [ $? = 1 ]; then
         done=true
      fi
   done
}

#-------------------------------------------------------------------------
# AddConfiguration
#
AddConfiguration()
{
   useold=false

   if [ -f $COMMONDIR/configuration ]; then
      Translate 0 "Creating global cluster configuration"
      $ECHO "-------------------------------------"
      $ECHO ""
      Translate 0 "A global cluster configuration file already exists."

      Translate 4 "Press <RETURN> to display the configuration >>"
      WaitClear noclear "\n$transout \c"

      cat $COMMONDIR/configuration |grep -v conf_version |more

      QMDIR_IN_CFG=`grep qmaster_spool_dir $COMMONDIR/configuration | awk '{print $2}'`
      if [ "$QMDIR_IN_CFG" != $QMDIR ]; then
         $CLEAR
         $ECHO ""
         Translate 0 "ERROR - new qmaster spool directory"
         $ECHO "-----------------------------------"
         $ECHO ""
         Translate 0 "The qmaster spool directory in your existing configuration is set to"
         $ECHO ""
         $ECHO "   $QMDIR_IN_CFG"
         $ECHO ""
         Translate 0 "and differs from your previous selection during this installation where you"
         Translate 0 "set the qmaster spool directory to"
         $ECHO ""
         $ECHO "   $QMDIR"
         $ECHO ""
         Translate 0 "Please either copy your old qmaster spool directory to the new directory and"
         Translate 0 "edit the existing cluster configuration file to reflect this change and"
         Translate 0 "restart the installation or delete the current cluster configuration file."
         $ECHO ""

         Translate 4 "Hit <RETURN> to cancel the installation >>"
         WaitClear noclear "$transout \c"
         exit 1
      else
         Translate 4 "Do you want to create a new configuration"
         YesNo "$transout" y
         if [ $? = 1 ]; then
            Translate 4 "Using existing configuration. Hit <RETURN> to continue >>"
            WaitClear noclear "$transout \c"
            useold=true
         fi
      fi
   fi

   if [ $useold = false ]; then
      GetConfiguration
      TruncCreateAndMakeWriteable $COMMONDIR/configuration
      PrintConf >> $COMMONDIR/configuration
      SetPerm $COMMONDIR/configuration
   fi

   TruncCreateAndMakeWriteable $COMMONDIR/product_mode
   if [ $inst = sge ]; then
      PRODUCT_PREFIX=sge
   else
      PRODUCT_PREFIX=sgeee
   fi
   
   if [ $resport = true ]; then
      RESPORT_PREFIX=-reserved_port
   else
      RESPORT_PREFIX=""
   fi

   if [ $afs = true ]; then
      AFS_PREFIX=-afs
   else
      AFS_PREFIX=""
   fi

   if [ $csp = true ]; then
      CSP_PREFIX=-csp
   else
      CSP_PREFIX=""
   fi

   $ECHO ${PRODUCT_PREFIX}${RESPORT_PREFIX}${AFS_PREFIX}${CSP_PREFIX} >> $COMMONDIR/product_mode
   SetPerm $COMMONDIR/product_mode
}

#-------------------------------------------------------------------------
# AddLocalConfiguration_With_Qconf
#
AddLocalConfiguration_With_Qconf()
{
   TMPL=/tmp/${HOST}
   rm -f $TMPL
   if [ -f $TMPL ]; then
      Translate 0 "Sorry - can't create local configuration. Can't delete file >%s<" "$TMPL"
   else
      Translate 0 "Creating local configuration for host >%s<" $HOST
      PrintLocalConf 0 > /tmp/$HOST
      Execute $V5BIN/qconf -Aconf /tmp/$HOST
      rm -f /tmp/$HOST
      Translate 0 "Local configuration for host >%s< created." $HOST
   fi
   WaitClear clear
}

#-------------------------------------------------------------------------
# AddLocalConfiguration
#
AddLocalConfiguration()
{
   useold=false

   $ECHO ""
   Translate 0 "Creating local configuration"
   if [ -f $LCONFDIR/$HOST ]; then
      $ECHO  "----------------------------"
      $ECHO "" 
      Translate 0 "A local configuration for this host already exists."

      Translate 4 "Press <RETURN> to display the configuration >>"
      WaitClear noclear "\n$transout \c"

      cat $LCONFDIR/$HOST |grep -v conf_version |more

      Translate 4 "Do you want to overrride this configuration with a default config"
      YesNo "\n$transout" n
      if [ $? = 1 ]; then
         Translate 4 "Keeping existing configuration"
         useold=true
      else
         Translate 4 "Creating new local configuration for this host"
 
      fi
      WaitClear noclear "\n$transout >> \c"
      $CLEAR
   fi

   if [ $useold = false ]; then
      TruncCreateAndMakeWriteable $LCONFDIR/$HOST
      PrintLocalConf 1 >> $LCONFDIR/$HOST
      SetPerm $LCONFDIR/$HOST
   fi
}

#-------------------------------------------------------------------------
# AddActQmaster: create act_qmaster file
#
AddActQmaster()
{
   Translate 0 "Creating >act_qmaster< file"

   TruncCreateAndMakeWriteable $COMMONDIR/act_qmaster
   $ECHO $HOST >> $COMMONDIR/act_qmaster
   SetPerm $COMMONDIR/act_qmaster
}

#-------------------------------------------------------------------------
# AddDefaultComplexes
#
AddDefaultComplexes()
{
   Translate 0 "Adding default complexes >host< and >queue<"
   for c in host queue; do
      if [ -f $QMDIR/complexes/$c -a -s $QMDIR/complexes/$c ]; then
         Translate 4 "Complex >%s< already exists - should complex be preserved" $c
         YesNo "$transout" y
         if [ $? = 1 ]; then
            Translate 0 "Overwriting existing complex >%s<" $c
            ExecuteAsAdmin cp util/resources/complexes/$c $QMDIR/complexes
         fi
      else
         ExecuteAsAdmin cp util/resources/complexes/$c $QMDIR/complexes
      fi
   done
   ExecuteAsAdmin chmod $FILEPERM $QMDIR/complexes/*
}

#-------------------------------------------------------------------------
# AddDefaultDepartement
#
AddDefaultDepartement()
{
   if [ $inst = sgeee ]; then
      Translate 0 "Adding SGEEE >defaultdepartment< userset"
      ExecuteAsAdmin $CP util/resources/usersets/defaultdepartment $QMDIR/usersets
      ExecuteAsAdmin $CHMOD $FILEPERM $QMDIR/usersets/defaultdepartment

      Translate 0 "Adding SGEEE >deadlineusers< userset"
      ExecuteAsAdmin $CP util/resources/usersets/deadlineusers $QMDIR/usersets
      ExecuteAsAdmin $CHMOD 644 $QMDIR/usersets/deadlineusers

   fi
}

#-------------------------------------------------------------------------
# AddCommonFiles
#    Copy files from util directory to common dir
#
AddCommonFiles()
{
   for f in sge_aliases qtask sge_request; do
      if [ $f = sge_aliases ]; then
         text="path aliases file" 
      elif [ $f = qtask ]; then
        text="qtcsh sample default request file"
      else
        text="default submit options file"
      fi
      Translate 0 "Adding >%s< $text" $f

      ExecuteAsAdmin cp util/$f $COMMONDIR
      ExecuteAsAdmin chmod $FILEPERM $COMMONDIR/$f
   done

   unset text f
}

#-------------------------------------------------------------------------
# AddDefaultManager
#
AddDefaultManager()
{
  TruncCreateAndMakeWriteable $QMDIR/managers
  $ECHO $1 >> $QMDIR/managers
  SetPerm $QMDIR/managers
}


#-------------------------------------------------------------------------
# ProcessQsystRoot: read SGE/SGEEE root directory and set $QSYST_ROOT
#                    check if $QSYST_ROOT matches current directory
#
ProcessQsystRoot()
{
   $CLEAR
   $ECHO
   Translate 0 "Checking %s directory" $QSYST_ROOT
   $ECHO "---------$LINES---------------"
   $ECHO ""

   done=false
   while [ $done = false ]; do
      if [ "`eval echo '$'$QSYST_ROOT`" = "" ]; then
         eval $QSYST_ROOT=`pwd | sed 's/\/tmp_mnt//'`
         export $QSYST_ROOT
         QSYST_ROOT_VAL=`eval echo '$'$QSYST_ROOT`

         Translate 0 "The %s root directory (your current directory) is:" "$QSYST"
         $ECHO ""
         $ECHO "   \$$QSYST_ROOT = $QSYST_ROOT_VAL"
         $ECHO ""
         Translate 0 "If this directory is not correct (e.g. it may contain an automounter" 
         Translate 0 "prefix) enter the correct path to this directory or hit <RETURN>"
         Translate 2 "to use default\n    \"%s\" >> " $QSYST_ROOT_VAL

         eval $QSYST_ROOT=`Enter $QSYST_ROOT_VAL`
         $ECHO
      fi

      QSYST_ROOT_VAL=`eval echo '$'$QSYST_ROOT`

      # do not check for correct QSYST_ROOT in case of -nostrict
      if [ "$strict" = true ]; then
         # create a file in QSYST_ROOT
         if [ $ADMINUSER != default ]; then
            $V5UTILBIN/adminrun $ADMINUSER $TOUCH $QSYST_ROOT_VAL/tst$$ 2> /dev/null > /dev/null
         else
            touch $QSYST_ROOT_VAL/tst$$ 2> /dev/null > /dev/null
         fi
         ret=$?
         # check if we have write permission
         if [ $ret != 0 ]; then
            $CLEAR
            $ECHO ""
            Translate 0 "Can't create a temporary file in the directory"
            $ECHO ""
            $ECHO "   \"$QSYST_ROOT_VAL\""
            $ECHO ""
            Translate 0 "This may be a permission problem (e.g. no read/write permission"
            Translate 0 "on a NFS mounted filesystem)."
            $ECHO ""
            Translate 0 "Please check your permissions. You may cancel the installation now" 
            Translate 0 "and restart it or continue and try again."
            $ECHO ""
            unset $QSYST_ROOT
            WaitClear clear
         elif [ ! -f tst$$ ]; then
            # check if QSYST_ROOT points to current directory
            Translate 0 "Your %s environment variable" "\$$QSYST_ROOT"
            $ECHO ""
            $ECHO "   \"$QSYST_ROOT_VAL\""
            $ECHO ""
            Translate 0 "doesn't match the current directory."
            $ECHO ""
            ExecuteAsAdmin $RM -f $QSYST_ROOT_VAL/tst$$
            unset $QSYST_ROOT
         else
            ExecuteAsAdmin $RM -f $QSYST_ROOT_VAL/tst$$
            done=true
         fi
      else
         done=true
      fi
   done

   Translate 0 "Your %s root directory: %s" $QSYST $QSYST_ROOT_VAL
   $ECHO
   WaitClear clear
}

#-------------------------------------------------------------------------
# GiveHints: give some useful hints at the end of the installation
#
GiveHints()
{

   if [ $autoinst = true ]; then
      return
   fi

   done=false
   while [ $done = false ]; do
      $CLEAR
      $ECHO ""
      Translate 0 "Using %s" "$QSYST"
      $ECHO "$LINES------"
      $ECHO ""
      Translate 0 "You should now enter the command:"
      $ECHO ""
      $ECHO "        % source $QSYST_ROOT_VAL/$QSYST_CELL_VAL/common/settings.csh"
      $ECHO ""
      Translate 0 "if you are a %s user or" "csh/tcsh"
      $ECHO ""
      $ECHO "        # . $QSYST_ROOT_VAL/$QSYST_CELL_VAL/common/settings.sh"
      $ECHO ""
      Translate 0 "if you are a %s user." "sh/ksh"
      $ECHO ""
      Translate 0 " This will set or expand the following environment variables" 
      Translate 0 "   - %s    (always necessary)" \$$QSYST_ROOT
      Translate 0 "   - %s    (if you are using a cell other than >default<)" \$$QSYST_CELL
      Translate 0 "   - %s     (if you haven't added the service %s)" \$COMMD_PORT "$QSYST_SERVICE"
      Translate 0 "     %s     (to find the %s binaries)" "\$PATH/\$path" "$QSYST"
      Translate 0 "   - %s     (to access the %s manual pages)" \$MANPATH "$QSYST"

      $ECHO ""

      Translate 4 "Press <RETURN> to see where %s logs messages >>" $QSYST
      WaitClear clear "$transout \c"

      $ECHO ""
      Translate 0 "%s messages" "$QSYST"
      $ECHO "$LINES---------"
      $ECHO ""
      Translate 0 "Messages from %s can be found in" "$QSYST"
      $ECHO ""
      Translate 0 "   %s (during %s qmaster startup)" /tmp/qmaster_messages $QSYST
      Translate 0 "   %s (during %s exec daemon startup)" /tmp/execd_messages $QSYST
      $ECHO ""
      Translate 0 "After the startup the daemons log their messages in their spool directories."
      $ECHO ""
      Translate 0 "%s qmaster:" "$QSYST"
      $ECHO ""
      $ECHO "   $QMDIR/messages"
      $ECHO ""
      Translate 0 "%s execution daemon" "$QSYST"
      $ECHO ""
      $ECHO "   <execd_spool_dir>/<hostname>/messages"

      Translate 4 "Do you want to see previous screen about using %s again" $QSYST
      YesNo "\n\n$transout" n
      if [ $? = 0 ]; then
         :
      else
         done=true
      fi
   done

   $CLEAR

   if [ $WHICH = master ]; then
      $ECHO ""
      Translate 0 "Your %s qmaster installation is now completed" "$QSYST"
      $ECHO "$LINES-------------------------------------------"
      $ECHO ""
      Translate 0 "Please now login to all hosts where you want to run an execution daemon"
      Translate 0 "and start the execution host installation procedure."
      $ECHO ""
      Translate 0 "If you want to run an execution daemon on this host, please do not forget"
      Translate 0 "to make the execution host installation in this host as well."
      $ECHO ""
      Translate 0 "All execution hosts must be administrative hosts during the installation."
      $ECHO ""
      Translate 0 "All hosts which you added to the list of administrative hosts during this"
      Translate 0 "installation procedure can now be installed."
      $ECHO ""
      Translate 0 "You may verify your adminstrative hosts with the command"
      $ECHO ""
      $ECHO "   qconf -sh"
      $ECHO ""
      Translate 0 " and you may add new adminstrative hosts with the command"
      $ECHO ""
      $ECHO "   qconf -ah <hostname>"
      $ECHO ""
      exit 0
   else
      $ECHO ""
      Translate 0 "Your %s execution daemon installation is now completed." "$QSYST"
   fi
}

#-------------------------------------------------------------------------
# CheckWhoInstallsQsyst
# 
CheckWhoInstallsQsyst()
{
   euid=`$V5UTILBIN/uidgid -euid`
   if [ $euid != 0 ]; then
      $CLEAR
      $ECHO ""
      Translate 0 "%s - test installation" "$QSYST"
      $ECHO "$LINES--------------------"
      $ECHO ""
      Translate 0 "You are installing %s not as user >root<!" "$QSYST"
      $ECHO ""
      Translate 0 "This will allow you to run %s only under your user id for testing" "$QSYST"
      Translate 0 "a limited functionality of %s." "$QSYST"
      $ECHO ""
      Translate 4 "Hit <RETURN> if this is ok or stop the installation with Ctrl-C >>"
      WaitClear clear "$transout \c"
      return 0
   fi

   # from here only root
   this_dir_user=`$V5UTILBIN/filestat -owner .`

   if [ $this_dir_user != root ]; then
      $CLEAR
      $ECHO ""
      Translate 0 "%s admin user account" "$QSYST"
      $ECHO "$LINES-------------------"
      $ECHO ""
      Translate 0 "The current directory is"
      $ECHO ""
      $ECHO "      `pwd`"
      $ECHO ""
      Translate 0 "is owned by user"
      $ECHO ""
      $ECHO "      $this_dir_user"
      $ECHO ""
      Translate 0 "If user >root< does not have write permissons in this directory on *all*"
      Translate 0 "of the machines where %s will be installed (NFS partitions not exported" "$QSYST"
      Translate 0 "for user >root< with read/write permissions) it is recommended to install"
      Translate 0 "%s that all spool files will be created under the user id" "$QSYST"
      Translate 0 "of user >%s<." $this_dir_user
      $ECHO ""
      Translate 0 "IMPORTANT NOTE: The daemons still have to be started by user >%s<" root

      Translate 4 "Do you want to install %s as admin user >%s<" $QSYST $this_dir_user
      YesNo "\n$transout" y
      if [ $? = 0 ]; then
         $ECHO ""
         Translate 0 "Installing application as admin user >%s<" "$this_dir_user"
         ADMINUSER=$this_dir_user
         WaitClear clear
         return
      else
         $CLEAR
      fi
   fi

   $ECHO ""
   Translate 0 "Choosing %s admin user account" "$QSYST"
   $ECHO "$LINES----------------------------"
   $ECHO ""
   Translate 0 "You may install %s that all files are created with the user id of an" $QSYST
   Translate 0 "unprivileged user."
   $ECHO ""
   Translate 0 "This will make it possible to install and run %s in directories" $QSYST
   Translate 0 "where user >%s< has no permissions to create and write files and directories." root
   $ECHO ""
   Translate 0 "   - %s still has to be started by user >%s<" "$QSYST" root
   Translate 0 "   - This directory and all distribution files already should be owned"
   Translate 0 "     by the %s administrator" "$QSYST"
   $ECHO ""
   Translate 4 "Do you want to install %s under an user id other than >%s<" "$QSYST" root
   YesNo "$transout" y

   if [ $? = 0 ]; then
      done=false
      while [ $done = false ]; do
         $CLEAR
         $ECHO ""
         Translate 0 "Choosing a %s admin user name" "$QSYST"
         $ECHO "$LINES---------------------------"
         $ECHO ""
         Translate 2 "Please enter the user name (or >%s<) >> " %s
         INP=`Enter ""`
         $V5UTILBIN/checkuser -check "$INP"
         if [ $? != 0 ]; then
            Translate 0 "The user %s does not exist - please correct the username" $INP
            WaitClear clear
         else
            $ECHO
            Translate 0 "Installing %s as user %s" $QSYST $INP
            $ECHO
            ADMINUSER=$INP
            if [ $ADMINUSER = root ]; then
               ADMINUSER=default
            fi
            WaitClear clear
            done=true
         fi
      done
   else
      $ECHO
      Translate 0 "Installing %s as user %s" "$QSYST" root
      $ECHO
      ADMINUSER=default
      WaitClear clear
   fi
}

#-------------------------------------------------------------------------
# CheckForCommdPort
#
CheckForCommdPort()
{
   host_type=$1
   if [ $resport = true ]; then
      commd_port_max=1023
   else
      commd_port_max=65500
   fi

   $V5UTILBIN/getservbyname $QSYST_SERVICE  >/dev/null 2>&1
   ret=$?

   if [ "$COMMD_PORT" != "" ]; then
      $ECHO ""
      Translate 0 "%s TCP/IP communication service" "$QSYST"
      $ECHO "$LINES-----------------------------"

      if [ $COMMD_PORT -ge 1 -a $COMMD_PORT -le $commd_port_max ]; then
         $ECHO ""
         Translate 0 "Using the environment variable"
         $ECHO ""
         $ECHO "   \$COMMD_PORT=$COMMD_PORT"
         $ECHO ""
         Translate 0 "as port for communication with >%s<." "$QSYST_COMMD_NAME"
         $ECHO ""
         if [ $ret = 0 ]; then
            Translate 0 "This overrides the preset TCP/IP service >%s<." "$QSYST_SERVICE"
            $ECHO ""
         fi
         WaitClear clear
         return
      else
         $ECHO ""
         Translate 0 "The environment variable"
         $ECHO "" 
         $ECHO "   \$COMMD_PORT=$COMMD_PORT"
         $ECHO "" 
         Translate 0 "has an invalid value (it must be in range 1..%s)." "$commd_port_max"
         $ECHO ""
         Translate 4 "Please set %s and restart\nthe installation or configure the service >%s<" \$COMMD_PORT $QSYST_SERVICE
         WaitClear noclear "$transout >> \c"
         exit 1
      fi
   fi

   if [ $ret != 0 ]; then
      $ECHO ""
      $ECHO "$QSYST \c"
      Translate 0 "TCP/IP service >%s<" "$QSYST_SERVICE"
      $ECHO "$LINES----------------$LINES-------------"
      $ECHO ""
      Translate 0 "There is no service >%s< available in your >/etc/services< file " "$QSYST_SERVICE"
      Translate 0 "or in your NIS/NIS+ database."
      $ECHO ""
      Translate 0 "You may"
      $ECHO ""
      Translate 0 "   - add this service now to your services database"
      Translate 0 "   - or choose a port number"
      $ECHO ""
      Translate 0 "It is recommended to add the service now. If you are using NIS/NIS+ you"
      Translate 0 "should add the service at your NIS/NIS+ server and not to the local"
      Translate 0 ">/etc/services< file."
      $ECHO ""
      Translate 0 "Please add an entry in the form"
      $ECHO ""
      $ECHO "   $QSYST_SERVICE port_number/tcp"
      $ECHO ""
      Translate 0 "to your services database and make sure to use an unused port number."
      $ECHO ""

      if [ "$host_type" = "exec" ]; then

         Translate 0 "Make sure to use the same port number as on the qmaster machine"
         $ECHO ""
      fi
      Translate 4 "Please add the service now or continue to enter a port number >>"
      WaitClear noclear "$transout \c"

      # Check if $QSYST_SERVICE service is available now
      service_available=false
      done=false
      while [ $done = false ]; do
         $V5UTILBIN/getservbyname $QSYST_SERVICE 2>/dev/null
         if [ $? != 0 ]; then
            $CLEAR
            $ECHO ""
            Translate 0 "No TCP/IP service >%s< yet" "$QSYST_SERVICE"
            $ECHO "-----------------------$LINES-------"
            $ECHO ""
            Translate 0 "There is still no service for >%s< available." "$QSYST_SERVICE"
            $ECHO ""
            Translate 0 "If you have just added the service it may take a while until the service"
            Translate 0 "propagates in your network. If this is true we can again check for"
            Translate 0 "the service >%s<. If you don't want to add this service or if" "$QSYST_SERVICE"
            Translate 0 "you want to install >%s< just for testing purposes you can enter" "$QSYST"
            Translate 0 "a port number."
            $ECHO ""
            Translate 4 "Check again (press >Y<) or enter port number now (y/number) [Y] >>"
            $ECHO "$transout \c"
            INP=`Enter Y`
            if [ $INP = y -o $INP = Y ]; then
               :
            else
               chars=`echo $INP | wc -c`
               chars=`expr $chars - 1`
               digits=`expr $INP : "[0-9][0-9]*"`
               if [ "$chars" != "$digits" ]; then
                  $ECHO ""
                  Translate 0 "Invalid input. Must be a number."
               elif [ $INP -le 1 -o $INP -ge $commd_port_max ]; then
                  $ECHO ""
                  Translate 0 "Invalid port number. Must be in range [1..$commd_port_max]."
               elif [ $INP -le 1024 -a $euid != 0 ]; then
                  $ECHO ""
                  Translate 0 "You are not user >root<. Use a port above 1024."
               else
                  ser=`awk '{ print $2 }' /etc/services | grep "^${INP}/tcp"`
                  if [ "$ser" = "$INP/tcp" ]; then
                     $ECHO ""
                     Translate 0 "Found service with port number >%s< in >/etc/services<. Choose again." "$INP"
                  else
                     done=true
                  fi
               fi
               if [ $done = false ]; then
                  WaitClear noclear
               fi
            fi
         else
            done=true
            service_available=true
         fi
      done

      if [ $service_available = false ]; then
         COMMD_PORT=$INP
         export COMMD_PORT
         $ECHO ""
         Translate 0 "Using port >%s<." "$COMMD_PORT"
         Translate 0 "No service >%s< available." "$QSYST_SERVICE"
         $ECHO ""
         WaitClear clear
      else
         unset COMMD_PORT
         Translate 0 "Service >%s< is now available." "$QSYST_SERVICE"
         $ECHO ""
         WaitClear clear
      fi
   else
      $ECHO ""
      Translate 0 "Using the service"
      $ECHO ""
      $ECHO "   $QSYST_SERVICE"
      $ECHO ""
      Translate 0 "for communication with >%s<." "$QSYST"
      $ECHO ""
      WaitClear clear
   fi
}

#-------------------------------------------------------------------------
# GetCell
#
GetCell()
{
   if [ $fast = true ]; then
      return
   fi

   $CLEAR
   $ECHO ""
   Translate 0 "%s cells" "$QSYST"
   $ECHO "$LINES------"
   $ECHO ""
   Translate 0 "%s supports multiple cells." "$QSYST"
   $ECHO ""
   Translate 0 "If you are not planning to run multiple %s clusters or if you don't" "$QSYST"
   Translate 0 "know yet what is a %s cell it is safe to keep the default cell name" "$QSYST"
   $ECHO ""
   $ECHO "   \"default\""
   $ECHO ""
   Translate 0 "If you want to run multiple cells you can enter a cell name now."
   Translate 0 "The environment variable"
   $ECHO ""
   $ECHO "   $QSYST_CELL=<your_cell_name>"
   $ECHO ""
   Translate 0 "will be set for all further %s commands." "$QSYST"
   $ECHO ""

   Translate 4 "Enter cell name or hit <RETURN> to use default cell >%s<" default
   $ECHO "$transout >> \c"
   INP=`Enter ""`
   if [ "$INP" = "" ]; then
      eval $QSYST_CELL=default
   else
      eval $QSYST_CELL=$INP
   fi

   QSYST_CELL_VAL=`eval echo '$'$QSYST_CELL`

   Translate 4 "\nUsing default cell: >%s<" $QSYST_CELL_VAL

   WaitClear clear
}

#-------------------------------------------------------------------------
# GetQmasterSpoolDir()
#
GetQmasterSpoolDir()
{
   euid=$1

   done=false
   while [ $done = false ]; do
      $CLEAR
      $ECHO ""
      Translate 0 "%s qmaster spool directory" "$QSYST"
      $ECHO "$LINES------------------------"
      $ECHO ""
      Translate 0 "The qmaster spool directory is the place where the %s qmaster" "$QSYST"
      Translate 0 "daemon stores the configuration and the state of the queuing system."
      $ECHO ""

      if [ $euid = 0 ]; then
         if [ $ADMINUSER = default ]; then
            Translate 0 "The >%s< user on this host must have read/write" root
         else
            Translate 0 "The admin user >%s< must have read/write" $ADMINUSER
         fi
      else
         Translate 2 "Your account on this host must have read/write "
      fi

      Translate 0 "access to the qmaster spool directory."
      Translate 0 "If you will install shadow master hosts or if you want to be able to"
      Translate 0 "start the qmaster daemon on other hosts (see the corresponding section"
      Translate 0 "in the %s Installation and Administration Manual for details) the account" "$QSYST"
      Translate 0 "on the shadow master hosts also needs read/write access to this directory."
      $ECHO ""
      Translate 0 "Enter spool directory or hit <RETURN> to use default"
      $ECHO "   \"$QSYST_ROOT_VAL/$QSYST_CELL_VAL/spool/qmaster\" >> \c"

      QMDIR=`Enter $QSYST_ROOT_VAL/$QSYST_CELL_VAL/spool/qmaster`

      $ECHO ""
      Translate 0 "The following directory has been selected as qmaster spool directory"
      $ECHO ""
      $ECHO "   $QMDIR"
      $ECHO ""
      Translate 4 "Do you want to select another qmaster spool directory"
      YesNo "$transout" n

      if [ $? = 1 ]; then
         done=true
      fi
   done
}

#-------------------------------------------------------------------------
# CheckQmasterInstallation
#
CheckQmasterInstallation()
{
   $CLEAR
   $ECHO ""
   Translate 0 "%s cells"  "$QSYST"
   $ECHO "$LINES------"
   $ECHO ""
   Translate 0 "Please enter cell name which you used for %s qmaster installation" "$QSYST"
   Translate 2 "or press <RETURN> to use default cell >default< >> "
   INP=`Enter ""`
   if [ "$INP" = "" ]; then
      eval $QSYST_CELL=default
   else
      eval $QSYST_CELL=$INP
   fi

   QSYST_CELL_VAL=`eval echo '$'$QSYST_CELL`

   SetCellDependentVariables

   if [ ! -f $COMMONDIR/act_qmaster ]; then
      $ECHO ""
      Translate 0 "Obviously there was no %s qmaster installation" "$QSYST"
      $ECHO ""
      Translate 0 "Call >./%s -m<" "$myname"
      $ECHO ""
      Translate 0 "on the machine which shall run the %s qmaster" "$QSYST"
      $ECHO ""
      exit 1
   else
      Translate 0 "Using default cell: >%s<" $QSYST_CELL_VAL
      $ECHO
   fi

   WaitClear clear
}

#-------------------------------------------------------------------------
# AddQsystStartUpScript: Add startup script to rc files if root installs
#
AddQsystStartUpScript()
{
   euid=$1
   create=$2

   $CLEAR
   $ECHO ""
   Translate 0 "%s startup script" "$QSYST"
   $ECHO "$LINES---------------"
   $ECHO ""

   TMP_V5_STARTUP_FILE=/tmp/rcsge.$$
   STARTUP_FILE_NAME=rcsge
   S95NAME=S95rcsge

   V5_STARTUP_FILE=$QSYST_ROOT_VAL/$COMMONDIR/$STARTUP_FILE_NAME

   if [ $create = true ]; then

      rm -f $TMP_V5_STARTUP_FILE ${TMP_V5_STARTUP_FILE}.0

      Execute sed -e "s%QSYST_ROOT%${QSYST_ROOT}%g" \
                  -e "s%QSYST_CELL%${QSYST_CELL}%g" \
                  -e "s%QSYST_NAME%${QSYST_NAME}%g" \
                  -e "s%QSYST_MASTER_NAME%${QSYST_MASTER_NAME}%g" \
                  -e "s%QSYST_SCHEDD_NAME%${QSYST_SCHEDD_NAME}%g" \
                  -e "s%QSYST_SHADOWD_NAME%${QSYST_SHADOWD_NAME}%g" \
                  -e "s%QSYST_EXECD_NAME%${QSYST_EXECD_NAME}%g" \
                  -e "s%QSYST_SHEPHERD_NAME%${QSYST_SHEPHERD_NAME}%g" \
                  -e "s%QSYST_COMMDCNTL_NAME%${QSYST_COMMDCNTL_NAME}%g" \
                  -e "s%GENROOT%${QSYST_ROOT_VAL}%g" \
                  -e "s%GENCELL%${QSYST_CELL_VAL}%g" \
                  -e "/#+-#+-#+-#-/,/#-#-#-#-#-#/d" \
                  util/startup_template > ${TMP_V5_STARTUP_FILE}.0

      if [ "$COMMD_PORT" != "" ]; then
         Execute sed -e "s/GENCOMMD_PORT/COMMD_PORT=$COMMD_PORT/" \
                     ${TMP_V5_STARTUP_FILE}.0 > $TMP_V5_STARTUP_FILE
      else
         Execute sed -e "/GENCOMMD_PORT/d" \
                     ${TMP_V5_STARTUP_FILE}.0 > $TMP_V5_STARTUP_FILE
      fi

      ExecuteAsAdmin $CP $TMP_V5_STARTUP_FILE $V5_STARTUP_FILE
      ExecuteAsAdmin $CHMOD a+x $V5_STARTUP_FILE

      rm -f $TMP_V5_STARTUP_FILE ${TMP_V5_STARTUP_FILE}.0 ${TMP_V5_STARTUP_FILE}.1

      if [ $euid = 0 -a $ADMINUSER != default -a $WHICH = "master" ]; then
         AddDefaultManager $ADMINUSER
      elif [ $euid != 0 ]; then
         AddDefaultManager $USER
      fi
   fi

   $ECHO ""
   Translate 0 "Your system wide %s startup script is installed as:" "$QSYST"
   $ECHO ""
   $ECHO "   \"$V5_STARTUP_FILE\""
   $ECHO ""
   WaitClear clear

   if [ $euid != 0 ]; then
      return 0
   fi

   # --- from here only if root installs ---
   Translate 4 "We can install a script that starts %s at system boot time" $QSYST
   YesNo "\n$transout" y

   if [ $? = 1 ]; then
      $CLEAR
      return
   fi

   echo

   # If we have System V we need to put the startup script to $RC_PREFIX/init.d
   # and make a link in $RC_PREFIX/rc2.d to $RC_PREFIX/init.d
   if [ "$RC_FILE" = "sysv_rc" ]; then
      Translate 0 "Installing startup script %s" "$RC_PREFIX/$RC_DIR/$S95NAME"
      Execute rm -f $RC_PREFIX/$RC_DIR/$S95NAME
      Execute cp $V5_STARTUP_FILE $RC_PREFIX/init.d/$STARTUP_FILE_NAME
      Execute chmod a+x $RC_PREFIX/init.d/$STARTUP_FILE_NAME
      Execute ln -s $RC_PREFIX/init.d/$STARTUP_FILE_NAME $RC_PREFIX/$RC_DIR/$S95NAME

      # runlevel management in Linux is different -
      # each runlevel contains full set of links
      # RedHat uses runlevel 5 and SUSE runlevel 3 for xdm
      # RedHat uses runlevel 3 for full networked mode
      # Suse uses runlevel 2 for full networked mode
      # we already installed the script in level 3
      if [ $ARCH = linux -o $ARCH = glinux -o $ARCH = alinux -o $ARCH = slinux ]; then
         runlevel=`grep "^id:.:initdefault:"  /etc/inittab | cut -f2 -d:`
         if [ "$runlevel" = 2 -o  "$runlevel" = 5 ]; then
            Translate 0 "Installing startup script also in %s" "$RC_PREFIX/rc${runlevel}.d/$S95NAME"
            Execute rm -f $RC_PREFIX/rc${runlevel}.d/$S95NAME
            Execute ln -s $RC_PREFIX/init.d/$STARTUP_FILE_NAME $RC_PREFIX/rc${runlevel}.d/$S95NAME
         fi
      fi
   elif [ "$RC_FILE" = "insserv-linux" ]; then
      echo  cp $V5_STARTUP_FILE $RC_PREFIX/$STARTUP_FILE_NAME
      echo /sbin/insserv $RC_PREFIX/$STARTUP_FILE_NAME
      Execute cp $V5_STARTUP_FILE $RC_PREFIX/$STARTUP_FILE_NAME
      /sbin/insserv $RC_PREFIX/$STARTUP_FILE_NAME
   else
      # if this is not System V we simple add the call to the
      # startup script to RC_FILE

      # Start-up script already installed?
      #------------------------------------
      grep $STARTUP_FILE_NAME $RC_FILE > /dev/null 2>&1
      status=$?
      if [ $status != 0 ]; then
         Translate 0 "Adding application startup to %s" $RC_FILE
         # Add the procedure
         #------------------
         $ECHO "" >> $RC_FILE
         $ECHO "" >> $RC_FILE
         $ECHO "# $QSYST start up" >> $RC_FILE
         $ECHO "#-$LINES---------" >> $RC_FILE
         $ECHO $V5_STARTUP_FILE >> $RC_FILE
      else
         Translate 0 "Found a call of %s in $s. Replacing with new call." $STARTUP_FILE_NAME $RC_FILE
         $ECHO
         Translate 0 "Your old %s is saved as %s" $RC_FILE $RC_FILE.org.1

         mv $RC_FILE.org.3 $RC_FILE.org.4    2>/dev/null
         mv $RC_FILE.org.2 $RC_FILE.org.3    2>/dev/null
         mv $RC_FILE.org.1 $RC_FILE.org.2    2>/dev/null

         # save original file modes of RC_FILE
         uid=`$V5UTILBIN/filestat -uid $RC_FILE`
         gid=`$V5UTILBIN/filestat -gid $RC_FILE`
         perm=`$V5UTILBIN/filestat -mode $RC_FILE`

         Execute cp $RC_FILE $RC_FILE.org.1

         savedfile=`basename $RC_FILE`

         sed -e "s%.*$STARTUP_FILE_NAME.*%$V5_STARTUP_FILE%" \
                 $RC_FILE > /tmp/$savedfile.1

         Execute cp /tmp/$savedfile.1 $RC_FILE
         Execute chown $uid $RC_FILE
         Execute chgrp $gid $RC_FILE
         Execute chmod $perm $RC_FILE
         Execute rm -f /tmp/$savedfile.1
      fi
   fi

   WaitClear clear
}

#-------------------------------------------------------------------------
# AddHostsFromFile: Get a list of hosts and add them as
# admin and submit hosts
#
AddHostsFromFile()
{
   file=$1
   done=false
   while [ $done = false ]; do
      $CLEAR
      $ECHO "" 
      Translate 0 "Adding admin and submit hosts from file"
      $ECHO "---------------------------------------"
      $ECHO ""
      Translate 4 "Please enter the file name which contains the host list:"
      $ECHO "$transout \c"
      file=`Enter none`
      if [ "$file" = "none" -o ! -f "$file" ]; then
         $ECHO ""
         Translate 0 "You entered an invalid file name or the file does not exist."
         Translate 4 "Do you want to enter a new file name"
         YesNo "\n$transout " y
         if [ $? = 1 ]; then
            return 1
         fi
      else
         for h in `cat $file`; do
            $V5BIN/qconf -ah $h
            $V5BIN/qconf -as $h
         done
         done=true
      fi
   done
}

#-------------------------------------------------------------------------
# AddHostsFromTerminal
#    Get a list of hosts and add the mas admin and submit hosts
#         
AddHostsFromTerminal()
{         
   stop=false
   while [ $stop = false ]; do
      $CLEAR
      $ECHO ""
      Translate 0 "Adding admin and submit hosts"
      $ECHO "-----------------------------"
      $ECHO ""
      Translate 0 "Please enter a blank seperated list of hosts. Stop by entering <RETURN>. You"
      Translate 0 "may repeat this step until you are entering an empty list. You will see"
      Translate 0 "messages from %s when the hosts are added." "$QSYST"
      $ECHO ""
      Translate 2 "Host(s): "
      hlist=`Enter ""`
      for h in $hlist; do
         $V5BIN/qconf -ah $h
         $V5BIN/qconf -as $h
      done
      if [ "$hlist" = "" ]; then
         stop=true
      else
         WaitClear noclear
      fi  
  done
}         

#-------------------------------------------------------------------------
# AddHosts
#         
AddHosts()
{
   $ECHO ""
   Translate 0 "Adding %s hosts" "$QSYST"
   $ECHO "-------$LINES------"
   $ECHO ""
   Translate 0 "Please now add the list of hosts, where you will later install your execution"
   Translate 0 "daemons. These hosts will be also added as valid submit hosts."
   $ECHO ""
   Translate 0 "Please enter a blank separated list of your execution hosts. You may"
   Translate 0 "press <RETURN> if the line is getting too long. Once you are finished"
   Translate 0 "simply press <RETURN> without entering a name."
   $ECHO ""
   Translate 0 "You also may prepare a file with the hostnames of the machines where you plan"
   Translate 0 "to install %s. This may be convenient if you are installing %s on " "$QSYST"
   Translate 0 "many hosts."
   $ECHO ""
   Translate 4 "Do you want to use a file which contains the list of hosts"
   YesNo "$transout" n
   ret=$? 
   if [ $ret = 0 ]; then
      AddHostsFromFile
      ret=$?
   fi     

   if [ $ret = 1 ]; then
      AddHostsFromTerminal
   fi     

   Translate 4 "Finished adding hosts. Hit <RETURN> to continue >>"
   WaitClear clear "\n$transout \c"
}         

#-------------------------------------------------------------------------
# AddQueue
#
AddQueue()
{
   if [ $addqueue = false ]; then
      return
   fi

   exechost=`$V5UTILBIN/gethostname -name | cut -f1 -d.`

#   This does not work on solaris64 when running in locale en_FW.MBE
#   because the tr -s " " doesn't work correctly :
#
#   slots=`$V5UTILBIN/loadcheck -loadval num_proc | tr -s " " | cut -f2 -d" "`
#
#  So let's do this:
#
   slots=`$V5UTILBIN/loadcheck -loadval num_proc | sed "s/num_proc *//"`

   $ECHO ""
   Translate 0 "Adding a default %s queue for this host" "$QSYST"
   $ECHO "-----------------$LINES--------------------"
   $ECHO ""
   Translate 0 "We can now add a sample queue for this host which"
   $ECHO ""
   Translate 0 "    - has the name >%s.q<" "${exechost}"
   Translate 0 "    - provides %s slot(s) for jobs" "$slots"
   Translate 0 "    - provides access for any user with an account on this machine"
   Translate 0 "    - and has no resource limits"
   $ECHO ""
   Translate 0 "You do not need to add a queue now, but before running jobs on this host"
   Translate 0 "need to add a queue with >qconf< or the GUI >qmon<."
   $ECHO ""

   Translate 4 "Do you want to add a default queue for this host"
   YesNo "$transout" y

   if [ $? = 0 ]; then
      TMPL=/tmp/queue_template.$$
      rm -f $TMPL ${TMPL}.q
      $V5BIN/qconf -sq > $TMPL
      Execute sed -e "/qname/s/template/${exechost}.q/" \
                  -e "/hostname/s/unknown/$exechost/" \
                  -e "/slots/s/1/$slots/" $TMPL > ${TMPL}.q
      $V5BIN/qconf -Aq ${TMPL}.q
      WaitClear clear
      rm -f $TMPL ${TMPL}.q
   fi
}

#-------------------------------------------------------------------------
# CreateSettingsFile: Create resource files for csh/sh
#
CreateSettingsFile()
{
   Translate 0 "Creating settings files for >%s<" ".profile/.cshrc"

   SP_CSH=$QSYST_ROOT_VAL/$COMMONDIR/settings.csh
   SP_SH=$QSYST_ROOT_VAL/$COMMONDIR/settings.sh

   TruncCreateAndMakeWriteable $SP_CSH
   TruncCreateAndMakeWriteable $SP_SH

   Translate 0 "Creating %s" $QSYST_ROOT_VAL/$COMMONDIR/settings.[c]sh

   $ECHO "set ARCH = \`$QSYST_ROOT_VAL/util/arch\`"                  >  $SP_CSH
   $ECHO "set DEFAULTMANPATH = \`$QSYST_ROOT_VAL/util/arch -m\`"     >> $SP_CSH
   $ECHO "set MANTYPE = \`$QSYST_ROOT_VAL/util/arch -mt\`"           >> $SP_CSH
   $ECHO ""                                                          >> $SP_CSH
   $ECHO "unsetenv $QSYST_ROOT"                                      >> $SP_CSH
   $ECHO "unsetenv $QSYST_CELL"                                      >> $SP_CSH
   $ECHO "unsetenv COMMD_PORT"                                       >> $SP_CSH
   $ECHO ""                                                          >> $SP_CSH
   $ECHO "setenv $QSYST_ROOT $QSYST_ROOT_VAL"                        >> $SP_CSH
   if [ "$QSYST_CELL_VAL" != "default" ]; then
      $ECHO "setenv $QSYST_CELL $QSYST_CELL_VAL"                     >> $SP_CSH
   fi
   if [ "$COMMD_PORT" != "" ]; then
      $ECHO "setenv COMMD_PORT $COMMD_PORT"                          >> $SP_CSH
   fi
   $ECHO ""                                                          >> $SP_CSH
   $ECHO 'if ( $?MANPATH == 1 ) then'                                >> $SP_CSH
   $ECHO "   setenv MANPATH $QSYST_ROOT_VAL/"'${MANTYPE}':'$MANPATH' >> $SP_CSH
   $ECHO "else"                                                      >> $SP_CSH
   $ECHO "   setenv MANPATH $QSYST_ROOT_VAL/"'${MANTYPE}:$DEFAULTMANPATH' >> $SP_CSH
   $ECHO "endif"                                                     >> $SP_CSH
   $ECHO ""                                                          >> $SP_CSH
   $ECHO "set path = ( $QSYST_ROOT_VAL/bin/"'$ARCH $path )'          >> $SP_CSH

   $ECHO "set shlib_path_name = \`$QSYST_ROOT_VAL/util/arch -lib\`"                     >> $SP_CSH
   $ECHO "if ( \`eval echo '\$?'\$shlib_path_name\` ) then"                             >> $SP_CSH
   $ECHO "   set old_value = \`eval echo '\$'\$shlib_path_name\`"                       >> $SP_CSH
   $ECHO "   setenv \$shlib_path_name \"\$old_value\":\"$QSYST_ROOT_VAL/lib/\$ARCH\""   >> $SP_CSH
   $ECHO "else"                                                                         >> $SP_CSH
   $ECHO "   setenv \$shlib_path_name $QSYST_ROOT_VAL/lib/\$ARCH"                       >> $SP_CSH
   $ECHO "endif"                                                                        >> $SP_CSH

   $ECHO "unset ARCH DEFAULTMANPATH MANTYPE"                         >> $SP_CSH


   $ECHO "ARCH=\`$QSYST_ROOT_VAL/util/arch\`"                        >  $SP_SH
   $ECHO "DEFAULTMANPATH=\`$QSYST_ROOT_VAL/util/arch -m\`"           >> $SP_SH
   $ECHO "MANTYPE=\`$QSYST_ROOT_VAL/util/arch -mt\`"                 >> $SP_SH
   $ECHO ""                                                          >> $SP_SH
   $ECHO "unset $QSYST_ROOT"                                         >> $SP_SH
   $ECHO "unset $QSYST_CELL"                                         >> $SP_SH
   $ECHO "unset COMMD_PORT"                                          >> $SP_SH
   $ECHO ""                                                          >> $SP_SH
   $ECHO "$QSYST_ROOT=$QSYST_ROOT_VAL; export $QSYST_ROOT"           >> $SP_SH
   if [ "$QSYST_CELL_VAL" != "default" ]; then
      $ECHO "$QSYST_CELL=$QSYST_CELL_VAL; export $QSYST_CELL"        >> $SP_SH
   fi
   if [ "$COMMD_PORT" != "" ]; then
      $ECHO "COMMD_PORT=$COMMD_PORT; export COMMD_PORT"              >> $SP_SH
   fi
   $ECHO ""                                                          >> $SP_SH
   $ECHO "if [ \"\$MANPATH\" = \"\" ]; then"                         >> $SP_SH
   $ECHO "   MANPATH=\$DEFAULTMANPATH"                               >> $SP_SH
   $ECHO "fi"                                                        >> $SP_SH
   $ECHO "MANPATH=$QSYST_ROOT_VAL/\$MANTYPE:\$MANPATH; export MANPATH"   >> $SP_SH
   $ECHO ""                                                          >> $SP_SH
   $ECHO "PATH=$QSYST_ROOT_VAL/bin/\$ARCH:\$PATH; export PATH"       >> $SP_SH

   $ECHO "shlib_path_name=\`$QSYST_ROOT_VAL/util/arch -lib\`"               >> $SP_SH
   $ECHO "old_value=\`eval echo '\$'\$shlib_path_name\`"                    >> $SP_SH
   $ECHO "if [ x\$old_value = "x" ]; then"                                  >> $SP_SH
   $ECHO "   eval \$shlib_path_name=$QSYST_ROOT_VAL/lib/\$ARCH"             >> $SP_SH
   $ECHO "else"                                                             >> $SP_SH
   $ECHO "   eval \$shlib_path_name=\$old_value:$QSYST_ROOT_VAL/lib/\$ARCH" >> $SP_SH
   $ECHO "fi"                                                               >> $SP_SH
   $ECHO "export \$shlib_path_name"                                         >> $SP_SH

   $ECHO "unset ARCH DEFAULTMANPATH MANTYPE"                         >> $SP_SH

   SetPerm $SP_CSH
   SetPerm $SP_SH
}

#--------------------------------------------------------------------------
# SetCellDependentVariables
#
SetCellDependentVariables()
{
   COMMONDIR=$QSYST_CELL_VAL/common
   LCONFDIR=$QSYST_CELL_VAL/common/local_conf
   CASHAREDDIR=$COMMONDIR/sgeCA
   HISTDIR=$COMMONDIR/history
}

#--------------------------------------------------------------------------
#
WelcomeTheUser()
{
   if [ $autoinst = true ]; then
      return
   fi

   Translate 0 "Welcome to the %s installation" $QSYST
   $ECHO "---------------$LINES-------------"
   $ECHO "" 
   Translate 0 "%s qmaster host installation" $QSYST
   $ECHO "$LINES--------------------------"
   $ECHO "" 
   Translate 0 "Before you continue with the installation please read these hints:"
   $ECHO ""
   Translate 0 "  - your terminal window should have a size of at least 80x24 characters."
   $ECHO ""
   Translate 0 "  - The INTR character is often bound to the key Ctrl-C. The term"
   Translate 0 "    Ctrl-C is used during the installation if you have the"
   Translate 0 "    possibility to abort the installation."
   $ECHO ""
   Translate 0 "The qmaster installation procedure will take approximately 5-10 minutes."
   $ECHO ""
   WaitClear clear  
}

#--------------------------------------------------------------------------
# WelcomeTheUserExecHost
#
WelcomeTheUserExecHost()
{
   if [ $autoinst = true ]; then
      return
   fi

   Translate 0 "Welcome to the %s installation" "$QSYST"
   $ECHO "---------------$LINES-------------" 
   $ECHO ""
   Translate 0 "%s execution host installation" "$QSYST"
   $ECHO "$LINES----------------------------"
   $ECHO ""
   Translate 0 "If you haven't installed the %s qmaster host yet, you must execute" "$QSYST"
   Translate 0 "this step (with >%s<) prior the execution host installation." "install_qmaster"
   $ECHO ""
   Translate 0 "For a sucessfull installation you need a running %s qmaster. It is" "$QSYST"
   Translate 0 "also neccesary that this host is an administrative host."
   $ECHO ""
   Translate 0 "You can verify your current list of administrative hosts with the command:"
   $ECHO ""
   $ECHO "   % qconf -sh"
   $ECHO ""
   Translate 0 "You can add an administrative host with the command:"
   $ECHO ""
   $ECHO "   % qconf -ah <hostname>"
   $ECHO ""
   Translate 0 "The execution host installation will take approximately 5 minutes."
   $ECHO ""

   WaitClear clear
}

#--------------------------------------------------------------------------
# WelcomeTheUserSubmit
#
WelcomeTheUserSubmit()
{
   Translate 0 "%s submit host installation" "$QSYST"
   $ECHO "$LINES-------------------------"
   $ECHO ""
   Translate 0 "Adding a submit host to the %s cluster is done with the command:" "$QSYST"
   $ECHO ""
   $ECHO "   % qconf -as hostname"
   $ECHO ""
   Translate 0 "This command must be entered from a machine which is an administration host."
   Translate 0 "The %s qmaster machine is by default an administration host." "$QSYST"
}

#--------------------------------------------------------------------------
# StartQmaster
#
StartQmaster()
{
   $ECHO ""
   Translate 0 "%s qmaster and scheduler startup" "$QSYST"
   $ECHO "$LINES------------------------------"
   $ECHO ""
   Translate 0 "Starting %s qmaster and scheduler daemon. Please wait ..." "$QSYST"

   $V5_STARTUP_FILE -qmaster

   WaitClear clear
}

#--------------------------------------------------------------------------
# StartExecd
#
StartExecd()
{
   $ECHO ""
   Translate 0 "%s execution daemon startup" "$QSYST"
   $ECHO "$LINES---------------------------"
   $ECHO ""
   Translate 0 "Starting %s execution daemon daemon. Please wait ..." "$QSYST"
   $V5_STARTUP_FILE -execd

   WaitClear clear
}

#--------------------------------------------------------------------------
# CheckBinaries
#
CheckBinaries()
{

BINFILES="sge_commd sge_coshepherd \
          sge_execd sge_qmaster  \
          sge_schedd sge_shadowd \
          sge_shepherd sgecommdcntl qacct qalter qconf qdel qhold \
          qhost qlogin qmake qmod qmon qresub qrls qrsh qselect qsh qstat qsub qtcsh"

UTILFILES="adminrun checkprog checkuser filestat gethostbyaddr gethostbyname \
           gethostname getservbyname loadcheck now qrsh_starter rlogin rsh rshd \
           testsuidroot uidgid"

THIRD_PARTY_FILES=openssl

   missing=false
   for f in $BINFILES; do
      if [ \! -f $V5BIN/$f ]; then
         missing=true
         Translate 0 "missing program %s in directory %s" $f $V5BIN
      fi
   done

   for f in $THIRD_PARTY_FILES; do
      if [ ! -f $V5UTILBIN/$f ]; then
        missing=true
        Translate 0 "missing program %s in directory %s" $f $V5BIN
      fi
   done

   for f in $UTILFILES; do
      if [ ! -f $V5UTILBIN/$f ]; then
         missing=true
         Translate 0 "missing program %s in directory %s" $f $V5UTILBIN
      fi
   done

   if [ $missing = true ]; then
      $ECHO ""
      Translate 0 "Missing %s binaries!" $QSYST
      $ECHO ""
      Translate 0 "A complete installation needs the following binaries in >%s<:" $V5BIN
      $ECHO ""
      $ECHO "qacct           qlogin          qrsh            sge_commd       sge_shepherd"
      $ECHO "qalter          qmake           qselect         sge_coshepherd  sgecommdcntl"
      $ECHO "qconf           qmod            qsh             sge_execd"
      $ECHO "qdel            qmon            qstat           sge_qmaster"
      $ECHO "qhold           qresub          qsub            sge_schedd"
      $ECHO "qhost           qrls            qtcsh           sge_shadowd"
      $ECHO ""
      Translate 0 "The binaries in >%s< are:" $V5UTILBIN
      $ECHO ""
      $ECHO "adminrun       gethostbyaddr  loadcheck      rlogin         uidgid"
      $ECHO "checkprog      gethostbyname  now            rsh"
      $ECHO "checkuser      gethostname    openssl        rshd"
      $ECHO "filestat       getservbyname  qrsh_starter   testsuidroot"
      $ECHO ""
      Translate 0 "Installation failed. Exit."
      exit 1
   fi
}

#--------------------------------------------------------------------------
# SetPermissions
#    - set permission for regular files to 644
#    - set permission for executables and directories to 755
#
SetPermissions()
{
   $CLEAR
   $ECHO 
   Translate 0 "Verifying and setting file permissions"
   $ECHO "--------------------------------------"
   $ECHO

   euid=`$V5UTILBIN/uidgid -euid`

   if [ $euid != 0 ]; then
      Translate 0 "You are not installing as user %s" root
      $ECHO
      Translate 0 "Can't set the file owner/group and permissions"
      $ECHO
      WaitClear clear 
      return 0
   else
      Translate 0 "Did you install this version with >pkgadd< or did you already"
      Translate 4 "verify and set the file permissions of your distribution"
      YesNo "$transout" y
      if [ $? = 0 ]; then
         Translate 4 "We do not verify file permissions. Hit <RETURN> to continue >>"
         WaitClear clear "\n$transout \c"
         return 0
      fi
   fi

   rm -f ./tst$$ 2> /dev/null > /dev/null
   touch ./tst$$ 2> /dev/null > /dev/null
   rm -f ./tst$$ 2> /dev/null > /dev/null
   ret=$?
   if [ $ret != 0 ]; then
      $CLEAR
      Translate 0 "Verifying and setting file permissions (continued)"
      $ECHO     "--------------------------------------------------"
      $ECHO

      Translate 0 "We can't set file permissions on this machine, because user root"
      Translate 0 "has not the necessary privileges to change file permissions"
      Translate 0 "on this file system."
      $ECHO
      Translate 0 "Probably this file system is an NFS mount where user root is"
      Translate 0 "mapped to user >nobody<."
      $ECHO
      Translate 0 "Please login now at your file server and set the file permissions and"
      Translate 0 "ownership of the entire distribution with the script:"
      $ECHO
      Translate 0 "   \$$QSYST_ROOT/util/setfileperm.sh <adminuser> <admingroup>"
      $ECHO
      Translate 0 "where <adminuser> and <admingroup> are the Unix user/group names under which"
      Translate 0 "the files should be installed and created."
      $ECHO
      Translate 4 "Please hit <RETURN> to continue once you set your file permissions >>"
      WaitClear clear "$transout \c"
      return 0
   elif [ $fast = false ]; then
      $CLEAR
      $ECHO
      Translate 0 "Verifying and setting file permissions"
      $ECHO "--------------------------------------"
      $ECHO ""
      Translate 0 "We may now verify and set the file permissions of your %s distribution." "$QSYST"
      $ECHO ""
      Translate 0 "This may be useful since due to unpacking and copying of your"
      Translate 0 "distribution your files may be unaccessible to other users."
      $ECHO ""
      Translate 0 "We will set the permissions of directories and binaries to"
      $ECHO ""
      Translate 0 "   755 - that means executable are accessible for the world"
      $ECHO ""
      Translate 0 "and for ordinary files to"
      $ECHO ""
      Translate 0 "   644 - that means readable for the world"
      Translate 4 "Do you want to verify and set your file permissions"
      YesNo "\n$transout" y
      ret=$?
   else
      ret=0
   fi

   if [ $ret = 0 ]; then

      if [ $resport = true ]; then
         resportarg=-resport
      else
         resportarg="-noresport"
      fi

      if [ $ADMINUSER = default ]; then
         fileowner=root
      else
         fileowner=$ADMINUSER
      fi

      filegid=`$V5UTILBIN/uidgid -gid`

      $CLEAR

      util/setfileperm.sh -auto $resportarg $fileowner $filegid $SGE_ROOT

      WaitClear clear
   else
      Translate 4 "We will not verify your file permissions. Hit <RETURN> to continue >>"
      WaitClear clear "\n$transout \c"
   fi
}

#--------------------------------------------------------------------------
# InitCA Create CA and initialize it for deamons and users
#
InitCA()
{

   if [ $csp = false ]; then
      return
   fi 

   # Initialize CA, make directories and get DN info
   #
   util/sgeCA/sge_ca -init

   if [ $? != 0 ]; then
      CAErrUsage
   fi

   WaitClear clear
}
   


#--------------------------------------------------------------------------
# THE MAIN PROCEDURE
#--------------------------------------------------------------------------

#-----------------------------------
# FIND ARCH + ARCH SPECIFIC DEFAULTS
#

myname=`basename $0`

cmdline=$*
for  arg in $*; do
   if [ $arg = -sgeee ]; then
      myname=inst_sgeee
   fi
done

set - $cmdline

if [ $myname = inst_sge ]; then
   inst=sge
   QSYST=SGE
   QSYST_NAME=SGE
   LINES=---
   BLANKS="  "
elif [ $myname = inst_sgeee ]; then
   inst=sgeee
   QSYST=SGEEE
   QSYST_NAME=SGEEE
   LINES=-----
   BLANKS=""
else
   echo  "unknown name of this script: $0"
   echo  "must be either >inst_sge<, >inst_sgeee<"
   echo  "may be the >basename< command is not in your \$PATH"
   echo
   exit 1
fi

QSYST_ROOT=SGE_ROOT
QSYST_CELL=SGE_CELL
QSYST_MASTER_NAME=sge_qmaster
QSYST_EXECD_NAME=sge_execd
QSYST_SCHEDD_NAME=sge_schedd
QSYST_SHEPHERD_NAME=sge_shepherd
QSYST_SHADOWD_NAME=sge_shadowd
QSYST_COMMD_NAME=sge_commd
QSYST_COMMDCNTL_NAME=sgecommdcntl
QSYST_SERVICE=sge_commd

if [ ! -f util/arch_variables ]; then
   echo "missing shell script \"util/arch_variables\""
   exit 1
fi

. ./util/arch_variables


if [ ! -f util/arch ]; then
   $ECHO "missing shell script \"util/arch\""
   exit 1
fi

#----------------------------------------------------
# setup i18n

if [ "$GETTEXT" != "" -a "SGE_I18N" = true ]; then
   unset TEXTDOMAINDIR TEXTDOMAIN
   TEXTDOMAINDIR="`/bin/pwd`/locale"
   TEXTDOMAIN=gridengine
   translation=1
else
   translation=0
   unset LANG LC_ALL LC_COLLATE LC_CTYPE LC_MESSAGES LC_MONETARY 
   unset LC_NUMERIC LC_TIME LANGUAGE
fi

# end of internationalization setup
#----------------------------------------------------

umask 022

unset GRD_DEBUG_LEVEL
unset COD_DEBUG_LEVEL
unset SGE_DEBUG_LEVEL

V5BIN=bin/$ARCH
V5UTILBIN=utilbin/$ARCH
QSYST_CELL_VAL=`eval echo '$'$QSYST_CELL`
if [ "$QSYST_CELL_VAL" = "" ]; then
   eval $QSYST_CELL=default
   QSYST_CELL_VAL=default
else
   QSYST_CELL_VAL=`eval echo '$'$QSYST_CELL`
fi
export $QSYST_CELL

ADMINUSER=default

# exit if there are missing binaries
#
CheckBinaries

MYUID=`$V5UTILBIN/uidgid -uid`
MYGID=`$V5UTILBIN/uidgid -gid`
DIRPERM=755
FILEPERM=644

HOST=`$V5UTILBIN/gethostname -name`

if [ "$HOST" = "" ]; then
   Translate 1 "can't determine your hostname. Installation failed."
   $ECHO >&2
   exit 1
fi

#-----------------------------
# commandline argument parsing
#
WHICH="undef"
strict=true
fast=false
autoinst=false
addqueue=true
resport=false
afs=false
csp=false

ARGC=$#
while [ $ARGC != 0 ]; do
   case $1 in
   -m)
      WHICH="master"
      ;;
   -x)
      WHICH="exec"
      ;;
   -s)
      WHICH="submit"
      ;;
   -afs)
      afs=true
      ;;
   -nostrict)
      strict=false
      ;;
   -resport)
      resport=true
      ;;
   -fast)
      fast=true
      ;;
   -auto)
      autoinst=true
      ;;
   -noqueue)
      addqueue=false
      ;;
   -csp)
      csp=true
      ;;
   *)
      $ECHO "" >&2
      Translate 1 "Error: Unknown option %s" $1
      ErrUsage $0
      ;;
   esac
   shift
   ARGC=`expr $ARGC - 1`
done

if [ "$WHICH" = "undef" ]; then
   ErrUsage $0
fi

$CLEAR

case $WHICH in
master)
   autoinst=false
   WelcomeTheUser
   PreCheckForFastInstall qmaster
   ret=$?

   if [ $ret = 0 ]; then
      AskIfDefaultOkAndSetVariables
      ret=$?
   fi

   if [ $ret != 0 ]; then
      CheckWhoInstallsQsyst
      ProcessQsystRoot
      CheckForCommdPort qmaster
      GetCell
      GetQmasterSpoolDir $euid
      SetCellDependentVariables
   fi

   SetPermissions
   MakeDirsMaster
   SelectHostNameResolving
   AddConfiguration
   $CLEAR
   AddLocalConfiguration
   AddActQmaster
   AddDefaultComplexes
   AddDefaultDepartement
   AddCommonFiles
   CreateSettingsFile
   WaitClear clear
   InitCA
   AddQsystStartUpScript $euid true
   StartQmaster
   AddHosts
   GiveHints
   ;;

exec)
   WelcomeTheUserExecHost
   PreCheckForFastInstall execd
   ret=$?
   if [ $ret = 0 ]; then
      AskIfDefaultOkAndSetVariables
      ret=$?
   fi

   if [ $ret != 0 ]; then
      CheckWhoInstallsQsyst
      ProcessQsystRoot
      CheckQmasterInstallation
      CheckForCommdPort exec
   fi
   CheckCellDirectory
   CheckHostNameResolving
   AddLocalConfiguration_With_Qconf
   AddQsystStartUpScript $euid false
   StartExecd
   AddQueue
   GiveHints
   ;;

submit)
   WelcomeTheUserSubmit
   ;;

esac

exit 0
