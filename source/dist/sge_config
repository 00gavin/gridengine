#!/bin/sh
#
# SGE/SGEEE configuration script (Installation/Uninstallation/Upgrade/Downgrade)
# Scriptname: sge_config
#
#___INFO__MARK_BEGIN__
##########################################################################
#
#  The Contents of this file are made available subject to the terms of
#  the Sun Industry Standards Source License Version 1.2
#
#  Sun Microsystems Inc., March, 2001
#
#
#  Sun Industry Standards Source License Version 1.2
#  =================================================
#  The contents of this file are subject to the Sun Industry Standards
#  Source License Version 1.2 (the "License"); You may not use this file
#  except in compliance with the License. You may obtain a copy of the
#  License at http://gridengine.sunsource.net/Gridengine_SISSL_license.html
#
#  Software provided under this License is provided on an "AS IS" basis,
#  WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING,
#  WITHOUT LIMITATION, WARRANTIES THAT THE SOFTWARE IS FREE OF DEFECTS,
#  MERCHANTABLE, FIT FOR A PARTICULAR PURPOSE, OR NON-INFRINGING.
#  See the License for the specific provisions governing your rights and
#  obligations concerning the Software.
#
#  The Initial Developer of the Original Code is: Sun Microsystems, Inc.
#
#  Copyright: 2001 by Sun Microsystems, Inc.
#
#  All Rights Reserved.
#
##########################################################################
#___INFO__MARK_END__
#
# set -x

#Reset PATH to a safe value
#
PATH=/bin:/usr/bin:/usr/sbin:/usr/bsd

# Easy way to prevent clearing of screen
#
CLEAR=clear
$CLEAR

# The same as clear!
#
ECHO=echo

# Sourcing common function module
#
PWD=`pwd`
. ./util/arch_variables
. ./sge_config_modules/sge_config_common.sh

#---------------------------------------
# commandline argument parsing
#---------------------------------------

UPGRADE=false
DOWNGRADE=false
BACKUP=false
AUTO=false
SGEEE=true
RESCHEDULE=true
RESPORT=false
CSP=false
AFS=false
NOREMOTE=false
START_RPC_SERVICE=false
ADD_TO_RC=false

QMASTER="undef"
EXECD="undef"
SHADOW="undef"
TAR="undef"
FILE="undef"
HOST="undef"
HOSTRANGE="undef"

SGE_NOMSG="undef"
LOGNAME=install.$$
DATE=`date '+%Y-%m-%d_%H:%M:%S'`

if [ -f /tmp/$LOGNAME ]; then
   rm /tmp/$LOGNAME
   touch /tmp/$LOGNAME
else
   touch /tmp/$LOGNAME
fi

BasicSettings
SetUpInfoText
CheckPath
CheckBinaries


ARGC=$#

if [ $ARGC = 0 ]; then
   ErrUsage
   exit 1
fi

while [ $ARGC != 0 ]; do
   case $1 in
   -auto)
     AUTO=true
     CLEAR=:
     SGE_NOMSG=1
     export SGE_NOMSG
     exec 1>/tmp/$LOGNAME 2>&1
     ;;
   -m)
     QMASTER="install"
     . ./sge_config_modules/sge_config_qmaster.sh 
     ;; 
   -dm)
     QMASTER="deactivate"
     #echo Deactivate qmaster
     ;;
   -um)
     QMASTER="uninstall"
     #echo Unistall qmaster
     ;;
   -x)
     EXECD="install"
     . ./sge_config_modules/sge_config_execd.sh
     ;;
   -dx)
     EXECD="deactivate"
     #echo Deactivate execd
     ;;
   -ux)
     EXECD="uninstall"
     . ./sge_config_modules/sge_config_execd_uninst.sh
     ;;
   -sm)
     SHADOW="install"
     #echo Install Shadowhost
     ;;
   -upd)
     UPGRADE=true
     #echo Upgrade gridengine
     ;;
   -dow)
     DOWNGRADE=true
     #echo Downgrade gridengine
     ;;
   -bup)
     BACKUP=true
     #echo Backup configuration
     ;;
   -host)
     if [ $AUTO = "false" -a $QMASTER = "install" ]; then
        EXEC_HOST_LIST=$2
     else
        HOST=$2
     fi
     #echo Un/install exechost $2
     shift
     ARGC=`expr $ARGC - 1`
     ;;
   -hostr)
     HOSTRANGE=$2
     #echo un/install exechostrange $2
     shift
     ARGC=`expr $ARGC - 1`
     ;;
   -noremote)
     NOREMOTE=true
     #Disable remote installation
     ;;
   -nr)
     RESCHEDULE=false
     #echo set reschedule to false
     ;;
   -resport)
     RESPORT=true
     #echo set resport to true
     ;;
   -file)
     FILE=$2
     #echo get infos from configfile $2
     shift
     ARGC=`expr $ARGC - 1`
     ;;
   -tar)
     TAR=$2
     #echo install gridengine from tarfile $2
     shift
     ARGC=`expr $ARGC - 1`
     ;;
   -csp)
     CSP=true
     ;;
   -afs)
     AFS=true
     ;;
   -help)
     ErrUsage
     ;;
   *)
     ErrUsage
     ;;
   esac
   shift
   ARGC=`expr $ARGC - 1`
done

if [ $AUTO = "false" -a $QMASTER = "undef" -a $EXECD = "install" -a $SHADOW = "install" -a $HOST != "" ]; then
   ErrUsage
fi
 
if [ $QMASTER = "install" ]; then

 if [ $AUTO = true ]; then
  {
    $INFOTEXT -log "Starting qmaster installation!"
    GetConfigFromFile
    CheckPath
  }
 fi

 WelcomeTheUser
 CheckWhoInstallsSGE
 ProcessSGERoot 
 #CheckCommPorts qmaster
 GetQmasterPort
 GetExecdPort
 #GetCellRoot
 GetCell
 GetQmasterSpoolDir $euid
 SetCellDependentVariables
 SetPermissions
 #SetSpoolingOptions
 SelectHostNameResolving
 SetProductMode
 MakeDirsMaster
 SetSpoolingOptions
 AddBootstrap
 InitSpoolingDatabase
 AddConfiguration
 AddLocalConfiguration
 AddActQmaster
 AddDefaultComplexes
 AddPEFiles
 AddDefaultDepartement
 AddCommonFiles
 CreateSettingsFile
 InitCA
 AddSGEStartUpScript $euid true master
 StartQmaster
 AddHosts
 GiveHints

 if [ $AUTO = true ]; then 
    MoveLog
 fi

fi


#if [ $QMASTER = "uninstall" ]; then


#fi

if [ $EXECD = "install" ]; then
 if [ $AUTO = true ]; then
    GetConfigFromFile
    CheckPath

    for h in $EXEC_HOST_LIST; do
   
      if [ $h = `hostname` ]; then
  
         WelcomeTheUserExecHost
         CheckWhoInstallsSGE 
         ProcessSGERoot
         CheckQmasterInstallation
         #CheckCommPorts execd
         #GetExecdPort
         CheckCellDirectory
         CheckCSP
         CheckHostNameResolving
         AddLocalConfiguration_With_Qconf
         AddSGEStartUpScript $euid true execd
         StartExecd
         AddQueue
         GiveHints

         if [ $AUTO = true ]; then
            MoveLog
         fi

      else
         if [ $QMASTER = "install" -o $NOREMOTE = "false" ]; then
            $INFOTEXT -log "remote installation on host %s" $h
            echo ". $SGE_ROOT/$SGE_CELL/common/settings.sh; cd $SGE_ROOT && ./sge_config -x -auto -noremote" | rsh $h /bin/sh &
         fi

      fi

    done
 
 else
      WelcomeTheUserExecHost
      CheckWhoInstallsSGE 
      ProcessSGERoot
      CheckQmasterInstallation
      #CheckCommPorts execd
      #GetExecdPort
      CheckCellDirectory
      CheckCSP
      CheckHostNameResolving
      AddLocalConfiguration_With_Qconf
      AddSGEStartUpScript $euid true execd 
      StartExecd
      AddQueue
      GiveHints
      
      if [ $AUTO = true ]; then
         MoveLog
      fi

      for h in $EXEC_HOST_LIST; do
        if [ $QMASTER = "install" -o $NOREMOTE = "false" ]; then
            $INFOTEXT "Starting remote installation on host %s" $h
            $INFOTEXT "This part runs in automatic mode," \
                      "be sure to have a valid configuration file"
            $INFOTEXT -wait -auto $AUTO -n "Hit <RETURN> to continue >> "
            echo ". $SGE_ROOT/$SGE_CELL/common/settings.sh; cd $SGE_ROOT && ./sge_config -x -auto -noremote" | rsh $h /bin/sh &
        fi
      done
  fi

 
fi


if [ $EXECD = "uninstall" ]; then
 
   INFOTEXT=$SGE_ROOT/$INFOTEXT
   . $SGE_ROOT/$SGE_CELL/common/settings.sh

   if [ $AUTO = "true" ]; then
      GetConfigFromFile
   fi
   FetchHostname
   
   if [ $AUTO = "true" ]; then
      MoveLog
   fi
 
   exit 0
fi

if [ $SHADOW = "install" ]; then

   if [ $AUTO = "false" ]; then   
      $INFOTEXT -wait "Make sure, that the host, you wish to configure as" \
                      "shadow host,\n has read/write permissions to the qmaster spool" \
                      "and SGE_ROOT/<cell>/common directory!\n Hit <Enter> to continue >>"
      $INFOTEXT "Please enter your SGE_ROOT directory or use the default\n[%s]!" $SGE_ROOT

      INP=`Enter ""`
      if [ "$INP" = "" ]; then
         SGE_ROOT=$SGE_ROOT
      else
         SGE_ROOT=$INP
      fi
      
      if [ $HOST = "" ]; then
         SHADOW_HOST=`hostname`
      else
         SHADOW_HOST=$HOST
      fi
 
      echo $SHADOW_HOST > $SGE_ROOT/$SGE_CELL/common/shadow_masters
      echo ". $SGE_ROOT/$SGE_CELL/common/settings.sh; $SGE_ROOT/bin/$ARCH/sge_shadowd &" | rsh $SHADOW_HOST /bin/sh &
   else
      $INFOTEXT -log "Starting sge_shadowd on host %s" $SHADOW_HOST      
      echo $SHADOW_HOST > $SGE_ROOT/$SGE_CELL/common/shadow_masters
      echo ". $SGE_ROOT/$SGE_CELL/common/settings.sh; $SGE_ROOT/bin/$ARCH/sge_shadowd &" | rsh $SHADOW_HOST /bin/sh &
   fi
fi

exit 0
