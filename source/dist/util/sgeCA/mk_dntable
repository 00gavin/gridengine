#!/bin/sh
#
# arguments:   $1 country code (e.g. DE)
#              $2 state or province (e.g. Bayern)
#              $3 locality name (e.g. Regensburg)
#              $4 organization name (e.g. Sun Microsystems)
#              $5 organizational unit name (e.g. Gridware)
C="DE"
ST="Bavaria"
L="Regensburg"
O="Sun Microsystems"
OU="Gridware"
SGE_CA_CMD=$SGE_ROOT/util/sgeCA/sge_ca

rm -rf /tmp/certificates
mkdir /tmp/certificates

CERTDIR=/tmp/certificates

while read i; do
echo "============================================================"
echo Generating certificate request for $i
filename=`echo $i| cut -d: -f 1`
CN=`echo $i| cut -d: -f 2`
emailAddress=`echo $CN|tr ' ' '.'`@sun.com
echo "C = $C" > $CERTDIR/SGE_DN.txt
echo "ST = $ST" >> $CERTDIR/SGE_DN.txt
echo "O = $O" >> $CERTDIR/SGE_DN.txt
echo "OU = $OU" >> $CERTDIR/SGE_DN.txt
echo "CN = $CN" >> $CERTDIR/SGE_DN.txt
echo "uniqueIdentifier = $filename" >> $CERTDIR/SGE_DN.txt
echo "emailAddress = $emailAddress" >> $CERTDIR/SGE_DN.txt
sed "/\[ req_distinguished_name \]/r $CERTDIR/SGE_DN.txt" $SGE_ROOT/util/sgeCA/sge_ssl_template.cnf > $CERTDIR/sge_ssl.cnf
mkdir $CERTDIR/$filename
$SGE_CA_CMD -req -batch -user $filename -outdir $CERTDIR/$filename
$SGE_CA_CMD -sign -batch -user $filename -outdir $CERTDIR/$filename -indir $CERTDIR/$filename
rm $CERTDIR/sge_ssl.cnf
rm $CERTDIR/SGE_DN.txt
done


